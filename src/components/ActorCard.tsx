import React, { FC } from 'react';
import { motion } from 'framer-motion';
import Actor, { Stat } from '../actors/Actor';
import Nameplate from './Nameplate';
import AuthorLink from './AuthorLink';

export enum ActorCardSection {
    STATS = 'stats',
    PORTRAIT = 'portrait',
}

interface ActorCardProps {
    actor: Actor;
    role?: string;
    collapsedSections?: ActorCardSection[];
    expandedSections?: ActorCardSection[];
    layout?: 'horizontal' | 'vertical';
    /** Whether the card is currently expanded (only used when forceExpanded is false) */
    isExpanded?: boolean;
    /** Callback when the card is clicked (only used when forceExpanded is false) */
    onClick?: () => void;
    /** Whether the card is being dragged */
    isDragging?: boolean;
    /** Whether the card is draggable */
    draggable?: boolean;
    /** Drag handlers */
    onDragStart?: (e: React.DragEvent) => void;
    onDragEnd?: () => void;
    /** Custom hover animation properties */
    whileHover?: any;
    /** Additional styles */
    style?: React.CSSProperties;
    /** Additional class name */
    className?: string;
}

/**
 * Reusable actor card component that displays actor information.
 * Can be in collapsed state (portrait + nameplate) or expanded state (adds stats).
 */
export const ActorCard: FC<ActorCardProps> = ({
    actor,
    role,
    collapsedSections = [ActorCardSection.STATS, ActorCardSection.PORTRAIT],
    expandedSections = [],
    layout = 'horizontal',
    isExpanded = false,
    onClick,
    isDragging = false,
    draggable = false,
    onDragStart,
    onDragEnd,
    whileHover,
    style,
    className
}) => {
    const currentSections = (isExpanded && expandedSections?.length > 0) ? expandedSections : collapsedSections;
    const clickable = !!onClick;

    // Default hover behavior
    const defaultWhileHover = {
        backgroundColor: (clickable || draggable) ? 'rgba(0, 255, 136, 0.15)' : undefined,
        borderColor: (clickable || draggable) ? 'rgba(0, 255, 136, 0.5)' : undefined,
    };

    // Create the wrapper element conditionally based on whether draggable or not
    const wrapperProps: any = {
        onClick: clickable ? onClick : undefined,
        animate: {
            opacity: isDragging ? 0.4 : 1,
            scale: isDragging ? 0.95 : 1,
        },
        whileHover: whileHover || defaultWhileHover,
        transition: {
            duration: 0.2
        },
        style: {
            padding: '12px',
            border: `3px solid #00ff88`,
            borderRadius: '8px',
            background: 'rgba(0, 10, 20, 0.5)',
            cursor: isDragging ? 'grabbing' : (draggable ? 'grab' : (clickable ? 'pointer' : 'default')),
            ...style
        },
        className
    };

    // Add HTML5 drag attributes if draggable
    if (draggable) {
        wrapperProps.draggable = true;
        wrapperProps.onDragStart = onDragStart;
        wrapperProps.onDragEnd = onDragEnd;
    }

    return (
        <motion.div {...wrapperProps}>
            {/* Nameplate at the top */}
            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '8px' }}>
                <Nameplate 
                    actor={actor} 
                    size="small"
                    role={role}
                    layout="stacked"
                />
            </div>
            
            {/* Sections in rows. */}
            <div style={{ display: 'flex', flexDirection: 'row', minHeight: '200px', overflow: 'hidden' }}>
                {currentSections.map(section => {
                    if (section === ActorCardSection.STATS) {
                        return <div className="stat-list" style={{ 
                                flex: '1', 
                                background: 'rgba(0,0,0,0.8)', 
                                borderRadius: '6px',
                                padding: '8px 10px',
                                overflow: 'visible',
                                display: 'flex',
                                flexDirection: 'column',
                                justifyContent: 'flex-start'
                            }}>
                                {/* Stats with letter grades. Each row here should be 1/8th of the container height. */}
                                {Object.values(Stat).map((stat) => {
                                    const grade = actor.scoreToGrade(actor.stats[stat]);
                                    return (
                                        <div className="stat-row" key={`${actor.id}_${stat}`} style={{
                                            height: '12%',
                                            maxHeight: '12%',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'space-between'
                                        }}>
                                            <span className="stat-label" style={{
                                                fontSize: '80%',
                                                textShadow: '2px 2px 0 rgba(0,0,0,0.88)',
                                                flex: '1'
                                            }}>{stat}</span>
                                            <span className="stat-grade" data-grade={grade} style={{
                                                fontSize: '100%',
                                                textShadow: '3px 3px 0 rgba(0,0,0,0.88)',
                                                transform: 'skewX(-8deg) rotate(-4deg)'
                                            }}>{grade}</span>
                                        </div>
                                    );
                                })}
                            </div>
                    } else if (section === ActorCardSection.PORTRAIT) {
                        return <div key="portrait" style={{ 
                            width: '100%',
                            flex: 1,
                            borderRadius: '6px',
                            overflow: 'hidden',
                            border: `2px solid ${actor.themeColor || '#00ff88'}`,
                            backgroundImage: `url(${actor.emotionPack?.neutral || actor.avatarImageUrl})`,
                            backgroundSize: 'cover',
                            backgroundPosition: 'top center',
                            backgroundRepeat: 'no-repeat',
                            position: 'relative',
                            display: 'flex',
                            alignItems: 'flex-end',
                            justifyContent: 'center'
                        }}>
                        </div>
                    }
                })}
            </div>
            {/* Author link in bottom */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <AuthorLink actor={actor} />
            </div>
        </motion.div>
    );
};

export default ActorCard;
